<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./css/plugins-f56e3a2542.css">
    <link  class="mainStyle" rel="stylesheet" href="./css/cart.min.css">
    <title>商品</title>
    <style></style>
<!--    <script src="../../HTML5学习/第二阶段八周/day31/requirejs/js/test.js"></script>-->
</head>
<body>

<div class="header">
    <div class="Top__container wrapx1200 clearfix">
        <div class="Top__pull-left">
            <a class="op__pull-left" href="http://10.36.135.7:3000/shops-page.html">
                <i></i>
                <span href="shops-page.html" >商城</span>
            </a>
        </div>
        <div class="Top__pull-right">
            <div>
                <ul class="styles__nav-options">
                    <li>
                        <div class="styles__nav-option">
                            <div>
                                <div class="BaseDropdown__dropdown">
                                    <div class="BaseDropdown__dropdown-toggle"><a class="nav-option-item"
                                                                                  href="javascript:;">
                                        <div class="AccountDropdown__account">我的帐号<span
                                                class="AccountDropdown__icon"><i class="_34FGS _3c0Qz"
                                                                                 style="font-family: quark;"></i></span></div>
                                    </a></div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <span class="space-shu"></span>
                    <li>
                        <div class="styles__nav-option">
                            <div><a data-test-locator="countrySelectBtn" role="presentation" class="nav-option-item">中国大陆
                                (简体中文 / ¥ CNY)</a></div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="main">
    <div class="style__content-container wrapx1200">
        <h1 class="title">我的购物车</h1>
    </div>
    <div class="sectionCartContent wrapx1200 container-fluid">
        <div class="shoppingCart-title clearfix">
            <span class="col-md-7">商品</span>
            <span class="col-md-1">价格</span>
            <span class="col-md-2">数量</span>
            <span class="col-md-1">小计</span>
            <span class="col-md-1"></span>
        </div>
        <div class="space-heng"></div>
        <div class=goods-list>
            <div class="row-content">
                <div class="col-md-7 row-product-info">
                    <div class="Selector__checkbox checkbox">
                        <lable>
                            <input type="checkbox" class="check "  value="on">
                        </lable>
                    </div>
                    <div class="goods-info">
                        <div class="goods-info-img">
                            <img src="https://product3.djicdn.com/uploads/sku/covers/31314/small_55e19eff-2d6a-4d75-8e63-b9b5822fd298.png" alt="">
                        </div>
                        <div class="goods-info-text">
                            <div class="product-title">
                                <a href="#" class="product-link">"御" Mavic 2 专业版</a>
                            </div>
                            <div class="shoppiing-tips">发货时间为订单付款后1个工作日。</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-1 row-price"><p>￥9999</p></div>
                <div class="col-md-2 row-num">
                    <div class="input-group numbersgroup text-center">
                        <span class="input-group-addon sub-btn numbers-btn">-</span>
                        <input type="text" aria-label=" " class="form-control numbers" value="1" data-toggle=" "
                               data-placement="top" data-content="请输入大于0的正整数">
                        <span class="input-group-addon add-btn  numbers-btn">+</span>
                    </div>
                </div>
                <div class="col-md-1 row-total-price">￥9999</div>
                <div class="col-md-1 row-delect">
                        <button class="btnDelete"><i></i></button>
                </div>
            </div>
            <div class="row-content">
                <div class="col-md-7 row-product-info">
                    <div class="Selector__checkbox checkbox">
                        <lable>
                            <input type="checkbox" class="check "  value="on">
                        </lable>
                    </div>
                    <div class="goods-info">
                        <div class="goods-info-img">
                            <img src="https://product3.djicdn.com/uploads/sku/covers/31314/small_55e19eff-2d6a-4d75-8e63-b9b5822fd298.png" alt="">
                        </div>
                        <div class="goods-info-text">
                            <div class="product-title">
                                <a href="#" class="product-link">"御" Mavic 2 专业版</a>
                            </div>
                            <div class="shoppiing-tips">发货时间为订单付款后1个工作日。</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-1 row-price"><p>￥9999</p></div>
                <div class="col-md-2 row-num">
                    <div class="input-group numbersgroup text-center">
                        <span class="input-group-addon sub-btn numbers-btn">-</span>
                        <input type="text" aria-label=" " class="form-control numbers" value="1" data-toggle=" "
                               data-placement="top" data-content="请输入大于0的正整数">
                        <span class="input-group-addon add-btn  numbers-btn">+</span>
                    </div>
                </div>
                <div class="col-md-1 row-total-price">￥9999</div>
                <div class="col-md-1 row-delect">
                        <button class="btnDelete"><i></i></button>
                </div>
            </div>
        </div>
        <div class="style__content">
            <div class="style__tips-container">
                <section>
                    <div class="Tips__item-container">
                        <section class="Tips__item">
                            <div><i class="_2bT-Y Tips__icon"></i></div>
                            <div>
                                <div class="Tips__title">购买即可获得价值支付金额1%的DJI币返利 - 购买越多，返利越多。</div>
                                <div class="Tips__desc"><a href="https://store.dji.com/cn/pages/dji-credit?from=cart"
                                                           target="_blank">了解更多优惠详情 &gt;</a></div>
                            </div>
                        </section>
                    </div>
                    <div class="Tips__item-container">
                        <section class="Tips__item">
                            <div><i class="_1lH5w Tips__icon"></i></div>
                            <div>
                                <div class="Tips__title">有优惠券或者 DJI 币？</div>
                                <div class="Tips__desc">您可以在结账的时候使用优惠券或者 DJI 币抵扣。</div>
                            </div>
                        </section>
                    </div>
                </section>
            </div>
            <div class="style__summary-container">
                <section class="Summary__container">
                    <div class="Summary__subtotal"><span>总计（不包括运费）:</span><span
                            class="semibold Summary__value">¥10787</span></div>
                    <div class="Summary__shipping-fee">
                        <div><span class="Summary__key">邮费:</span><span class="Summary__value">免费</span></div>
                    </div>
                    <div class="Summary__installment">支持支付宝、微信、银联、花呗和招行分期。</div>
                </section>
            </div>
        </div>
        <div class="cart__btn">
            <div class="btnContinueShopping">
                <a href="http://10.36.135.7:3000/shops-page.html"><button class="btn btn-lg btn-default">继续购物</button></a>
            </div>
            <div class="btnCheckout">
                <button  class="btn btn-lg btn-primary">去结算</button>
            </div>
        </div>
    </div>
</div>


<!--底部-->
<div class="shops-footer"></div>


<script src="./js/jquery-3.3.1.min.js"></script>
<script src="./js/plugins-151b8b410a.js"></script>
<script src="./js/require.2.1.9.js" data-main="./js/main.min.js"></script>
<script>
    $('.shops-footer').load('./shop-footer.html');
    //购物车的数量加减按钮// 商品数量计数

    var cart =  $('.goods-list');

    // 数量加减
    (function () {
        cart.on('click','.sub-btn',function () {
            var number =  $(this).siblings('.numbers');
            if (number.val() <= 1){
                console.log('最少需要加入加入一件');
                number.val(1);
                return false;
            }
            number.val(parseInt(number.val()) - 1);
            nums(number);

            // $(this).parent().parent
        });
        cart.on('click','.add-btn',function () {
            var number =  $(this).siblings('.numbers');

            number.val(parseInt(number.val()) + 1);
            nums(number);
        });
        cart.on('input','.numbers',function () {
            // 初始化工具提示和弹出框
            $(function () {
                $('[data-toggle="popover"]').popover()
            });
            var regNums = /^\d+$/g;
            if (regNums.test($(this).val()) && $(this).val() > 0){
                nums($(this));
                $(this).attr('data-toggle','');
                $(this).parent().removeClass('has-error')

            }else {
                console.log('输入有误');
                $(this).attr('data-toggle','popover');
                $(this).parent().addClass('has-error')
                // pullData();
            }
        });



        function nums(_product,_number) {


            // localStorage -> key  :  value
            //  goodcodes     : "{"abc2":3,"abc3":1}"
            // var _product = code;/*商品名称*/
            // var _number = Number($('.product-container .numbers').val());/*商品数量*/

            if (localStorage.getItem('goodcodes')){
                var codeJSON = JSON.parse(localStorage.getItem('goodcodes'));
                var state = [];//设置监听加入购物车的code是否匹配
                for (var ind in codeJSON){
                    if (ind === _product){
                        codeJSON[ind] = _number; //检测到添加过购物车的就给数字加1
                        state.push(1);//如果匹配到给状态push1
                    }else {
                        state.push(0)
                    }
                }
                if (state.indexOf(1) === -1){//检测是否有1-->也就是加入购物车的是否是已经加过的，没有加过就新增一条
                    codeJSON[_product] = _number;
                    state.length = 0;
                }
            }else {//如果本地存储中为空，则新建一个数组保存code和数量
                var codeJSON = {};
                codeJSON[_product] = _number;
            }

            // 把获得的code添加到从本地数据缓存中拿到的数据，并且赋值回去给缓存数据
            var goodsStr = JSON.stringify(codeJSON);
            console.log(goodsStr);
            localStorage.setItem('goodcodes',goodsStr);
        }
    })();





    // var code = location.href.split("?")[1];

function ajax(data,cb) {
    $.ajax({
        url:'http://10.36.135.7:3000/all_product',
        type: 'get',
        data: data,
        dataType: "json",
        success: cb,
        error : function (err) {
            console.log(err)
        }
    });
}

(function () {
    var _cart = $('.goods-list');
    if (localStorage.getItem('goodcodes')){
        var _ele = '';
        var codeJSON = JSON.parse(localStorage.getItem('goodcodes'));
        console.log(codeJSON);
        ajax({"data":'product'},function (data) {
            var _all_product = data;
            $.each(codeJSON,function (ind,nums) {
                // console.log(ind)
                $.each(_all_product,function (index,item) {
                    if (item["slug"] === ind){
                        _ele += addCartList({
                            "title":item["product_title"],
                            'price':item["price_cents"]/100,
                            'nums':nums,
                            'img':item["cover_image"],
                        });
                    }
                })
            });
            _cart.html("").append(_ele);/*添加商品到购物车*/
        });

    }else {//如果本地存储中为空，
        _cart.html('购物车空空如也');
    }
})();

/*购物车商品列表*/
function addCartList(dom) {

    var  ele = ` <div class="row-content">
                <div class="col-md-7 row-product-info">
                    <div class="Selector__checkbox checkbox">
                        <lable>
                            <input type="checkbox" class="check "  value="on">
                        </lable>
                    </div>
                    <div class="goods-info">
                        <div class="goods-info-img">
                            <img src=${dom.img} alt=${dom.title}>
                        </div>
                        <div class="goods-info-text">
                            <div class="product-title">
                                <a href="http://localhost:3000/goods.html?${dom.title}" class="product-link">${dom.title}</a>
                            </div>
                            <div class="shoppiing-tips">发货时间为订单付款后1个工作日。</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-1 row-price"><p>￥${dom.price}</p></div>
                <div class="col-md-2 row-num">
                    <div class="input-group numbersgroup text-center">
                        <span class="input-group-addon sub-btn numbers-btn">-</span>
                        <input type="text" aria-label=" " class="form-control numbers" value=${dom.nums} data-toggle=" "
                               data-placement="top" data-content="请输入大于0的正整数">
                        <span class="input-group-addon add-btn  numbers-btn">+</span>
                    </div>
                </div>
                <div class="col-md-1 row-total-price">￥${dom.price*dom.nums}</div>
                <div class="col-md-1 row-delect">
                        <button class="btnDelete"><i></i></button>
                </div>
            </div>`;
    return ele;
}

/*添加购物车*/
    // ajax_cart('http://10.36.135.7:3000/cart',{"act":"push","username":_user,"data":goodsStr},function (data) {
    //     console.log('成功加入购物车');
    //     $('.showMsg').click()
    // });







    (function () {
        var _cart = $('.goods-list');
        if (localStorage.getItem('goodcodes')){
            var _ele = '';
            var codeJSON = JSON.parse(localStorage.getItem('goodcodes'));
            console.log(codeJSON);
            ajax({"data":'product'},function (data) {
                var _all_product = data;
                $.each(codeJSON,function (ind,nums) {
                    // console.log(ind)
                    $.each(_all_product,function (index,item) {
                        if (item["slug"] === ind){
                            _ele += addCartList({
                                "title":item["product_title"],
                                'price':item["price_cents"]/100,
                                'nums':nums,
                                'img':item["cover_image"],
                            });
                        }
                    })
                });
                _cart.html("").append(_ele);/*添加商品到购物车*/
            });
            // async function pullCart(){
            //     ajax_cart('http://10.36.135.7:3000/cart',{"act":"pull","username":_user,},function (data) {
            //         console.log(357+JSON.stringify(data));
            //         return data;
            //     });
            // }
            // pullCart().then((data) =>{
            //     console.log(403+data)
            // });
        }else {//如果本地存储中为空，
            _cart.html('购物车空空如也');
        }
    })();

    // async function pullCart(){
    //     ajax_cart('http://10.36.135.7:3000/cart',{"act":"pull","username":_user,},function (data) {
    //         console.log(357+JSON.stringify(data));
    //         return data;
    //     });
    // }
    // pullCart().then((data) =>{
    //     console.log(403+data)
    // });



    function ajax_cart(url,data,cb) {
        $.ajax({
            url:url,
            type: 'get',
            data: data,
            dataType: "json",
            success: cb,
            error : function (err) {
                console.log(err)
            }
        });
    }
</script>

</body>
</html>