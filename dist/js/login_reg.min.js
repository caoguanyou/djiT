"use strict";

/*登陆注册*/
var _register = " <div class=\"style_register\">\n                    <div class=\"register-logo\">\n                        <img src=\"./images/logo-b.svg\" alt=\"\">\n                    </div>\n                    <div class=\"text-center\">\u6CE8\u518C</div>\n                    <div class=\"formArea\">\n                        <div class=\"name\">\n                            <input type=\"text\" name=\"username\" id=\"register-username\">\n                            <label class=\"holder\" for=\"register-username\">\u90AE\u7BB1/\u624B\u673A*</label>\n                        </div>\n                        <div class=\"pass\">\n                            <input type=\"password\" name=\"userpw\" id=\"register-userpw\">\n                            <label class=\"holder\" for=\"register-userpw\">\u5BC6\u7801*</label>\n                        </div>\n                        <div class=\"submit-btn\">\n                            <input type=\"button\" value=\"\u6CE8\u518C\" class=\"btn btn-lg btn-primary btn-register\">\n                            <p class=\"tips\"></p>\n                        </div>\n                    </div>\n                    <a href=\"./login_reg.html?login\" class=\"dji-login dji-link\">\u7ACB\u5373\u767B\u9646</a>\n                </div>";
var _login = "  <div class=\"style_login\">\n                   <div class=\"text-center\">\u767B\u9646</div>\n                   <div  class=\"formArea\" >\n                       <div class=\"name\">\n                           <input type=\"text\" name=\"username\" id=\"username\">\n                           <label class=\"holder\" for=\"username\">\u90AE\u7BB1/\u624B\u673A*</label>\n                       </div>\n                       <div class=\"pass\">\n                           <input type=\"password\" name=\"userpw\" id=\"userpw\">\n                           <label class=\"holder\" for=\"userpw\">\u5BC6\u7801*</label>\n                           <a href=\"#\" class=\"forget\">\u5FD8\u8BB0\u5BC6\u7801?</a>\n                       </div>\n                       <div class=\"submit-btn\">\n                           <input type=\"button\" value=\"\u767B\u9646\" class=\"btn btn-lg btn-primary btn-login\">\n                           <p class=\"tips\"></p>\n                       </div>\n                   </div>\n                   <a href=\"./login_reg.html?register\" class=\"dji-register dji-link\">\u6CE8\u518CDJI\u8D26\u53F7</a>\n               </div>";
/*进入监测href是否带有注册关键字，没有就显示登陆*/

if (location.href.indexOf("register") === -1) {
  $('.login_register').append(_login);
} else {
  $('.login_register').append(_register);
}

var mySwiper = new Swiper('#loginSwipre', {
  direction: 'horizontal',
  // 垂直切换选项
  loop: true,
  // 循环模式选项
  // 如果需要分页器
  pagination: {
    el: '.login-swiper-pagination'
  },
  // 如果需要前进后退按钮
  navigation: {
    nextEl: '.login-swiper-button-next',
    prevEl: '.login-swiper-button-prev'
  }
});
/*页面载入就滑动form窗口到中间*/

$(window).ready(function () {
  var scT = $(window).height() / 2 - $('.formArea').height() / 2;
  setTimeout(function () {
    $('html,body').animate({
      scrollTop: scT + 'px'
    }, 800);
  }, 1000);
});
var entry = $('.login_register');
entry.on("focus", '.formArea input', function () {
  $(this).next().animate({
    'font-size': '14px',
    'top': "-25px"
  }, 400);
});
entry.on("blur", '.formArea input', function () {
  if ($(this).val() === "") {
    $(this).next().animate({
      'font-size': '14px',
      'top': "0px"
    }, 400);
  } else {
    $(this).next().animate({
      'font-size': '14px',
      'top': "-25px"
    }, 400);
  }
});
entry.on("click", '.btn-register', function () {
  if ($('#register-username').val() === '' || $('#register-userpw').val() === '') {
    $('.tips').html("账号密码不能为空");
    return false;
  }

  console.log("注册");
  loginAndRegister('register', {
    user: $('#register-username').val(),
    pass: $('#register-userpw').val()
  });
});
entry.on("click", '.btn-login', function () {
  if ($('#username').val() === '' || $('#userpw').val() === '') {
    $('.tips').html("账号密码不能为空");
    return false;
  }

  loginAndRegister('login', {
    user: $('#username').val(),
    pass: $('#userpw').val()
  }); // console.log($('#username').val(),$('#userpw').val())
}); // login登陆验证
//使用发布订阅模式 登陆
// 登陆&注册ajax

function loginAndRegister(act, val) {
  //ajax请求使用ajax
  $.ajax({
    type: 'get',
    url: "http://10.36.135.7:3000/".concat(act),
    data: "act=".concat(act, "&username=").concat(val.user, "&password=").concat(val.pass),
    success: function success(data) {
      console.log(data);
      var json = data; // '{"err":"1","msg":"${result"}';

      if (json.err === '1') {
        //如果登陆成功输出1，失败输出0
        // login_register.trigger('登陆成功', json);//TODO:使用发布订阅模式 登陆
        require(['pub-sub.min', "cookie.min"], function (login_register, cookie) {
          login_register.trigger('登陆成功', json); //TODO:使用发布订阅模式 登陆
          // 登陆或注册成功的时候把账号密码保存在cookie

          cookie.setCookie('username', json.msg[0].username, 0.005);
          cookie.setCookie('userpass', json.msg[0].password, 0.005);
        }); //登陆成功延时关闭登陆页面


        (function () {
          var i = 3;
          var timer1 = null;
          $('.tips').html("\u767B\u9646\u6210\u529F\uFF0C".concat(i, "\u79D2\u540E\u8FD4\u56DE"));
          timer1 = setInterval(function () {
            i--;
            $('.tips').html("\u767B\u9646\u6210\u529F\uFF0C".concat(i, "\u79D2\u540E\u8FD4\u56DE"));
            console.log(i);

            if (i < 0) {
              //计时4秒后返回
              clearInterval(timer1);
              $('.tips').html('');
              history.go(-1);
              /*返回上一页*/
            }
          }, 1000);
        })();
      } else if (json.err === '0') {
        $('.tips').html(json.msg);
      } else {
        $('.tips').html('出错');
      }
    }
  });
}